<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Viewer</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% if request.endpoint == 'frame' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/frame.css') }}">
    {% endif %}
    <!-- WORKING CONFIGURATION - display_mode_toggle.js disabled due to performance issues -->
    {% if request.endpoint != 'index' %}
    <script src="{{ url_for('static', filename='js/websocket.js') }}"></script>
    <script src="{{ url_for('static', filename='js/media_helper.js') }}"></script>
    <script src="{{ url_for('static', filename='js/thumbnail_click.js') }}"></script>
    {% endif %}
    <script src="{{ url_for('static', filename='js/nsfw_filter.js') }}"></script>
    <script src="{{ url_for('static', filename='js/archive_filter.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar_toggle.js') }}"></script>
    {% if request.endpoint != 'index' %}
    <script src="{{ url_for('static', filename='js/image_size_toggle.js') }}"></script>
    {% endif %}
    <!-- DISABLED: causes page freeze <script src="{{ url_for('static', filename='js/display_mode_toggle.js') }}"></script> -->
    <script src="{{ url_for('static', filename='js/media_filter.js') }}"></script>
    <script src="{{ url_for('static', filename='js/thumbnail_slider.js') }}"></script>
    <script src="{{ url_for('static', filename='js/content_scan.js') }}"></script>
    <script src="{{ url_for('static', filename='js/content_lock.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
    <!-- <script src="{{ url_for('static', filename='js/keyboard_nav.js') }}"></script> -->
</head>

<body>
    <!-- Login Modal -->
    <div id="login-modal" class="modal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border);">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-lock-fill me-2"></i>Login Required</h5>
                </div>
                <div class="modal-body">
                    <form onsubmit="handleLogin(event); return false;">
                        <div class="mb-3">
                            <label for="login-passphrase" class="form-label">Passphrase</label>
                            <input type="password" class="form-control" id="login-passphrase"
                                placeholder="Enter passphrase" autocomplete="off" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="login-remember">
                            <label class="form-check-label" for="login-remember">Remember me for 30 days</label>
                        </div>
                        <div id="login-error" class="alert alert-danger" style="display: none;"></div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Login
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Safemode Unlock Modal -->
    <div id="safemode-unlock-modal" class="modal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border);">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-shield-lock-fill me-2"></i>Unlock Safe Mode</h5>
                    <button type="button" class="btn-close btn-close-white"
                        onclick="hideSafemodeUnlockModal()"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Enter the safemode passphrase to disable Safe Mode.</p>
                    <form onsubmit="handleSafemodeUnlock(event); return false;">
                        <div class="mb-3">
                            <input type="password" class="form-control" id="safemode-passphrase"
                                placeholder="Safemode passphrase" autocomplete="off" required>
                        </div>
                        <div id="safemode-unlock-error" class="alert alert-danger" style="display: none;"></div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary flex-grow-1"
                                onclick="hideSafemodeUnlockModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-warning flex-grow-1">
                                <i class="bi bi-unlock-fill me-2"></i>Unlock
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Scan Unlock Modal -->
    <div id="content-scan-unlock-modal" class="modal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border);">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-shield-exclamation me-2"></i>Unlock Content Scan</h5>
                    <button type="button" class="btn-close btn-close-white"
                        onclick="hideContentScanUnlockModal()"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Enter the passphrase to toggle Content Scan.</p>
                    <form onsubmit="handleContentScanUnlock(event); return false;">
                        <div class="mb-3">
                            <input type="password" class="form-control" id="content-scan-passphrase"
                                placeholder="Content scan passphrase" autocomplete="off" required>
                        </div>
                        <div id="content-scan-unlock-error" class="alert alert-danger" style="display: none;"></div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary flex-grow-1"
                                onclick="hideContentScanUnlockModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-warning flex-grow-1">
                                <i class="bi bi-unlock-fill me-2"></i>Unlock
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Hide Archive View Unlock Modal -->
    <div id="archive-view-unlock-modal" class="modal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border);">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-archive me-2"></i>Unlock Hide Archive</h5>
                    <button type="button" class="btn-close btn-close-white"
                        onclick="hideHideArchiveUnlockModal()"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Enter the passphrase to toggle Hide Archive.</p>
                    <form onsubmit="handleHideArchiveUnlock(event); return false;">
                        <div class="mb-3">
                            <input type="password" class="form-control" id="archive-view-passphrase"
                                placeholder="Hide archive passphrase" autocomplete="off" required>
                        </div>
                        <div id="archive-view-unlock-error" class="alert alert-danger" style="display: none;"></div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary flex-grow-1"
                                onclick="hideHideArchiveUnlockModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-warning flex-grow-1">
                                <i class="bi bi-unlock-fill me-2"></i>Unlock
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Lock Unlock Modal -->
    <div id="content-lock-unlock-modal" class="modal" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border);">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-lock me-2"></i>Unlock Content Lock</h5>
                    <button type="button" class="btn-close btn-close-white"
                        onclick="hideContentLockUnlockModal()"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Enter the passphrase to toggle Content Lock.</p>
                    <form onsubmit="handleContentLockUnlock(event); return false;">
                        <div class="mb-3">
                            <input type="password" class="form-control" id="content-lock-passphrase"
                                placeholder="Content lock passphrase" autocomplete="off" required>
                        </div>
                        <div id="content-lock-unlock-error" class="alert alert-danger" style="display: none;"></div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary flex-grow-1"
                                onclick="hideContentLockUnlockModal()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-warning flex-grow-1">
                                <i class="bi bi-unlock-fill me-2"></i>Unlock
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal modal-lg" tabindex="-1" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" style="max-width: 700px;">
            <div class="modal-content"
                style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border); max-height: 85vh;">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="bi bi-gear-fill me-2"></i>Settings</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="hideSettingsModal()"></button>
                </div>
                <div class="modal-body" style="overflow-y: auto;">
                    <form id="settings-form">

                        <!-- Global Settings -->
                        <div class="settings-section mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-folder-fill me-2"></i>Global Settings
                            </h6>
                            <div class="mb-3">
                                <label class="form-label">Image Folder Path</label>
                                <input type="text" class="form-control" id="setting-IMAGE_FOLDER"
                                    placeholder="E:\AI\Output">
                                <small class="text-muted">Path to the main image folder to monitor</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Initial Load</label>
                                <input type="number" class="form-control" id="setting-MAX_INITIAL_LOAD" min="10"
                                    max="500" value="100">
                                <small class="text-muted">Maximum images to load on home page (rest load via
                                    scroll)</small>
                            </div>
                        </div>

                        <!-- Startup Defaults -->
                        <div class="settings-section mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-power me-2"></i>Startup Defaults
                            </h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="setting-SAFE_MODE_DEFAULT">
                                <label class="form-check-label" for="setting-SAFE_MODE_DEFAULT">
                                    Safe Mode <small class="text-muted">- Hide flagged/NSFW files</small>
                                </label>
                                <small class="text-muted d-block ms-4">Hides files in NSFW folders and files matching
                                    NSFW keywords</small>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="setting-CONTENT_SCAN_DEFAULT">
                                <label class="form-check-label" for="setting-CONTENT_SCAN_DEFAULT">
                                    Content Scan <small class="text-muted">- Auto-detect & flag new files</small>
                                </label>
                                <small class="text-muted d-block ms-4">Scans new images using AI nudity detection and
                                    keyword matching</small>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="setting-CONTENT_LOCK_DEFAULT">
                                <label class="form-check-label" for="setting-CONTENT_LOCK_DEFAULT">
                                    Content Lock <small class="text-muted">- Hide specific folders</small>
                                </label>
                                <small class="text-muted d-block ms-4">Hides files in configured Content Lock
                                    folders</small>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="setting-HIDE_ARCHIVE_DEFAULT">
                                <label class="form-check-label" for="setting-HIDE_ARCHIVE_DEFAULT">
                                    Hide Archive <small class="text-muted">- Hide archived content</small>
                                </label>
                            </div>
                        </div>

                        <!-- Authentication -->
                        <div class="settings-section mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-shield-lock-fill me-2"></i>Authentication
                            </h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="setting-AUTH_ENABLED">
                                <label class="form-check-label" for="setting-AUTH_ENABLED">
                                    Enable Authentication <small class="text-muted">- Disables Guest and Require
                                        login</small>
                                </label>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">User Passphrase</label>
                                    <input type="password" class="form-control" id="setting-USER_PASSPHRASE">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Admin Passphrase</label>
                                    <input type="password" class="form-control" id="setting-ADMIN_PASSPHRASE">
                                </div>
                            </div>
                        </div>

                        <!-- Settings Access -->
                        <div class="settings-section mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-gear-fill me-2"></i>Settings Access
                            </h6>
                            <small class="text-muted d-block mb-3">Control who can open the settings menu</small>

                            <div class="card bg-dark mb-3">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label class="form-label mb-0">Settings Menu</label>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm" id="setting-SETTINGS_LEVEL">
                                                <option value="guest">Guest (Anyone)</option>
                                                <option value="user">User (Logged in)</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="password" class="form-control form-control-sm"
                                                id="setting-SETTINGS_PASSPHRASE" placeholder="Override passphrase">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Permissions -->
                        <div class="settings-section mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-person-badge-fill me-2"></i>Action Permissions
                            </h6>
                            <small class="text-muted d-block mb-3">Set minimum user level and override passphrase for
                                each action</small>

                            <!-- Delete Files -->
                            <div class="card bg-dark mb-3">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label class="form-label mb-0">Delete Files</label>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm" id="setting-DELETE_LEVEL">
                                                <option value="guest">Guest (Anyone)</option>
                                                <option value="user">User (Logged in)</option>
                                                <option value="admin">Admin Only</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="password" class="form-control form-control-sm"
                                                id="setting-DELETE_PASSPHRASE" placeholder="Override passphrase">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Flag/Unflag Files -->
                            <div class="card bg-dark mb-3">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label class="form-label mb-0">Flag/Unflag Files</label>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm" id="setting-FLAG_LEVEL">
                                                <option value="guest">Guest (Anyone)</option>
                                                <option value="user">User (Logged in)</option>
                                                <option value="admin">Admin Only</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="password" class="form-control form-control-sm"
                                                id="setting-FLAG_PASSPHRASE" placeholder="Override passphrase">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Archive Files -->
                            <div class="card bg-dark mb-3">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label class="form-label mb-0">Archive Files</label>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm" id="setting-ARCHIVE_LEVEL">
                                                <option value="guest">Guest (Anyone)</option>
                                                <option value="user">User (Logged in)</option>
                                                <option value="admin">Admin Only</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="password" class="form-control form-control-sm"
                                                id="setting-ARCHIVE_PASSPHRASE" placeholder="Override passphrase">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Toggle Permissions -->
                        <div class="settings-section mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-toggles me-2"></i>Toggle Permissions
                            </h6>
                            <small class="text-muted d-block mb-3">Set permission level and override passphrase for each
                                toggle</small>

                            <!-- Content Scan Toggle -->
                            <div class="card bg-dark mb-3">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label class="form-label mb-0">Content Scan Toggle</label>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm"
                                                id="setting-TOGGLE_CONTENT_SCAN_LEVEL">
                                                <option value="guest">Guest (Anyone)</option>
                                                <option value="user">User (Logged in)</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="password" class="form-control form-control-sm"
                                                id="setting-TOGGLE_CONTENT_SCAN_PASSPHRASE"
                                                placeholder="Override passphrase">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Content Lock Toggle -->
                            <div class="card bg-dark mb-3">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label class="form-label mb-0">Content Lock Toggle</label>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm"
                                                id="setting-TOGGLE_CONTENT_LOCK_LEVEL">
                                                <option value="guest">Guest (Anyone)</option>
                                                <option value="user">User (Logged in)</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="password" class="form-control form-control-sm"
                                                id="setting-TOGGLE_CONTENT_LOCK_PASSPHRASE"
                                                placeholder="Override passphrase">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hide Archive Toggle -->
                            <div class="card bg-dark mb-3">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label class="form-label mb-0">Hide Archive Toggle</label>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm"
                                                id="setting-TOGGLE_HIDE_ARCHIVE_LEVEL">
                                                <option value="guest">Guest (Anyone)</option>
                                                <option value="user">User (Logged in)</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="password" class="form-control form-control-sm"
                                                id="setting-TOGGLE_ARCHIVE_PASSPHRASE"
                                                placeholder="Override passphrase">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Safe Mode Toggle -->
                            <div class="card bg-dark mb-3">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label class="form-label mb-0">Safe Mode Toggle</label>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm"
                                                id="setting-TOGGLE_SAFEMODE_VIEW_LEVEL">
                                                <option value="guest">Guest (Anyone)</option>
                                                <option value="user">User (Logged in)</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="password" class="form-control form-control-sm"
                                                id="setting-TOGGLE_SAFEMODE_PASSPHRASE"
                                                placeholder="Override passphrase">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Safe Mode Settings -->
                        <div class="settings-section mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-shield-fill me-2"></i>Safe Mode Settings
                            </h6>
                            <div class="alert alert-info py-2 mb-3">
                                <small><strong>Safe Mode</strong> uses NSFW Keywords
                                    to identify what to hide.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">NSFW Keywords</label>
                                <textarea class="form-control" id="setting-NSFW_KEYWORDS" rows="3"
                                    placeholder="adult, bikini, nude..."></textarea>
                                <small class="text-muted">Comma-separated keywords checked in image metadata</small>
                            </div>
                        </div>

                        <!-- Content Scan Settings -->
                        <div class="settings-section mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-eye-fill me-2"></i>Content Scan Settings
                            </h6>
                            <div class="alert alert-warning py-2 mb-3">
                                <small><strong>Content Scan</strong> automatically detects and flags new files.
                                    It uses an AI-based NudeNet to scan incoming images.
                                    Flagged files are moved to NSFW folders.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">NSFW Folders</label>
                                <input type="text" class="form-control" id="setting-NSFW_FOLDERS"
                                    placeholder="NSFW, Adult, Explicit">
                                <small class="text-muted">Comma-separated folder names where flagged content is moved -
                                    In addition to NSFW. Hidden by content lock.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Safe Folders</label>
                                <input type="text" class="form-control" id="setting-SAFE_FOLDERS" placeholder="SAFE">
                                <small class="text-muted">Comma-separated folder names that skip further content
                                    scanning - In addition
                                    to SAFE</small>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Scan Offset</label>
                                    <input type="number" class="form-control" id="setting-CONTENT_SCAN_OFFSET" min="0"
                                        max="10" value="0">
                                    <small class="text-muted">Skip N newest images before scanning</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nudity Threshold</label>
                                    <input type="range" class="form-range" id="setting-NUDITY_THRESHOLD" min="0" max="1"
                                        step="0.05" value="0.5">
                                    <small class="text-muted">Lower = more sensitive (<span
                                            id="threshold-value">0.5</span>)</small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">NSFW Labels (NudeNet)</label>
                                <small class="text-muted d-block mb-2">AI-detected body parts that trigger NSFW
                                    flagging</small>
                                <div class="row" id="nsfw-labels-container">
                                    <!-- Exposed Labels -->
                                    <div class="col-md-6">
                                        <div class="card bg-dark mb-2">
                                            <div class="card-body py-2">
                                                <small class="text-warning d-block mb-2">Exposed (High Priority)</small>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="FEMALE_BREAST_EXPOSED" id="label-FEMALE_BREAST_EXPOSED">
                                                    <label class="form-check-label"
                                                        for="label-FEMALE_BREAST_EXPOSED">Female Breast</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="FEMALE_GENITALIA_EXPOSED"
                                                        id="label-FEMALE_GENITALIA_EXPOSED">
                                                    <label class="form-check-label"
                                                        for="label-FEMALE_GENITALIA_EXPOSED">Female Genitalia</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="MALE_GENITALIA_EXPOSED"
                                                        id="label-MALE_GENITALIA_EXPOSED">
                                                    <label class="form-check-label"
                                                        for="label-MALE_GENITALIA_EXPOSED">Male Genitalia</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="BUTTOCKS_EXPOSED" id="label-BUTTOCKS_EXPOSED">
                                                    <label class="form-check-label"
                                                        for="label-BUTTOCKS_EXPOSED">Buttocks</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="ANUS_EXPOSED" id="label-ANUS_EXPOSED">
                                                    <label class="form-check-label"
                                                        for="label-ANUS_EXPOSED">Anus</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="BELLY_EXPOSED" id="label-BELLY_EXPOSED">
                                                    <label class="form-check-label"
                                                        for="label-BELLY_EXPOSED">Belly</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Covered Labels -->
                                    <div class="col-md-6">
                                        <div class="card bg-dark mb-2">
                                            <div class="card-body py-2">
                                                <small class="text-info d-block mb-2">Covered (Lower Priority)</small>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="FEMALE_BREAST_COVERED" id="label-FEMALE_BREAST_COVERED">
                                                    <label class="form-check-label"
                                                        for="label-FEMALE_BREAST_COVERED">Female Breast</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="FEMALE_GENITALIA_COVERED"
                                                        id="label-FEMALE_GENITALIA_COVERED">
                                                    <label class="form-check-label"
                                                        for="label-FEMALE_GENITALIA_COVERED">Female Genitalia</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="MALE_GENITALIA_COVERED"
                                                        id="label-MALE_GENITALIA_COVERED">
                                                    <label class="form-check-label"
                                                        for="label-MALE_GENITALIA_COVERED">Male Genitalia</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="BUTTOCKS_COVERED" id="label-BUTTOCKS_COVERED">
                                                    <label class="form-check-label"
                                                        for="label-BUTTOCKS_COVERED">Buttocks</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="ANUS_COVERED" id="label-ANUS_COVERED">
                                                    <label class="form-check-label"
                                                        for="label-ANUS_COVERED">Anus</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input nsfw-label-check" type="checkbox"
                                                        value="BELLY_COVERED" id="label-BELLY_COVERED">
                                                    <label class="form-check-label"
                                                        for="label-BELLY_COVERED">Belly</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Additional Labels -->
                                    <div class="col-12">
                                        <div class="card bg-dark">
                                            <div class="card-body py-2">
                                                <small class="text-secondary d-block mb-2">Other Labels</small>
                                                <div class="row">
                                                    <div class="col-6 col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input nsfw-label-check"
                                                                type="checkbox" value="FEET_EXPOSED"
                                                                id="label-FEET_EXPOSED">
                                                            <label class="form-check-label"
                                                                for="label-FEET_EXPOSED">Feet Exposed</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input nsfw-label-check"
                                                                type="checkbox" value="FEET_COVERED"
                                                                id="label-FEET_COVERED">
                                                            <label class="form-check-label"
                                                                for="label-FEET_COVERED">Feet Covered</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input nsfw-label-check"
                                                                type="checkbox" value="ARMPITS_EXPOSED"
                                                                id="label-ARMPITS_EXPOSED">
                                                            <label class="form-check-label"
                                                                for="label-ARMPITS_EXPOSED">Armpits Exposed</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input nsfw-label-check"
                                                                type="checkbox" value="ARMPITS_COVERED"
                                                                id="label-ARMPITS_COVERED">
                                                            <label class="form-check-label"
                                                                for="label-ARMPITS_COVERED">Armpits Covered</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input nsfw-label-check"
                                                                type="checkbox" value="FACE_FEMALE"
                                                                id="label-FACE_FEMALE">
                                                            <label class="form-check-label" for="label-FACE_FEMALE">Face
                                                                Female</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-6 col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input nsfw-label-check"
                                                                type="checkbox" value="FACE_MALE" id="label-FACE_MALE">
                                                            <label class="form-check-label" for="label-FACE_MALE">Face
                                                                Male</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                    </form>

                    <div id="settings-error" class="alert alert-danger" style="display: none;"></div>
                    <div id="settings-success" class="alert alert-success" style="display: none;"></div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" onclick="hideSettingsModal()">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">
                        <i class="bi bi-check-lg me-2"></i>Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal backdrop -->
    <div id="modal-backdrop" class="modal-backdrop" style="display: none;"></div>

    <!-- Auth overlay - blocks page content until authenticated (shown by default if auth enabled) -->
    {% if config.AUTH_ENABLED %}
    <div id="auth-overlay" class="auth-overlay" style="display: block;"></div>
    {% else %}
    <div id="auth-overlay" class="auth-overlay" style="display: none;"></div>
    {% endif %}

    <div class="container" id="main-content" {% if config.AUTH_ENABLED
        %}style="filter: blur(20px); pointer-events: none;" {% endif %}>
        <nav class="navbar navbar-expand-md navbar-dark rounded">
            <div class="container-fluid">
                <a class="navbar-brand" href="{{ url_for('index') }}"> AI Photo Frame</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <!-- Left section: Navigation links -->
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'index' %}active{% endif %}"
                                href="{{ url_for('index') }}">
                                <i class="bi bi-house-fill me-1"></i> Home
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'gallery' %}active{% endif %}"
                                href="{{ url_for('gallery') }}">
                                <i class="bi bi-grid-3x3-gap-fill me-1"></i> Gallery
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if request.endpoint == 'frame' %}active{% endif %}"
                                href="{{ url_for('frame') }}">
                                <i class="bi bi-aspect-ratio-fill me-1"></i> Frame
                            </a>
                        </li>
                    </ul>

                    <!-- Center section: Media Type Filter -->
                    <div class="navbar-nav mx-auto">
                        {% if request.endpoint != 'frame' %}
                        <div class="btn-group" role="group" aria-label="Media type filter">
                            <button type="button" class="btn btn-sm btn-outline-primary media-filter-btn active"
                                data-filter="all">
                                <i class="bi bi-collection"></i> All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary media-filter-btn"
                                data-filter="photos">
                                <i class="bi bi-image"></i> Photos
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary media-filter-btn"
                                data-filter="videos">
                                <i class="bi bi-play-btn"></i> Videos
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Right section: Safe Mode + Fullscreen -->
                    <div class="d-flex align-items-center gap-3">
                        <!-- Safe Mode Toggle -->
                        <div class="toggle-stack">
                            <label class="toggle-label" for="nsfw-toggle">Safe Mode</label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="nsfw-toggle">
                            </div>
                        </div>

                        <!-- Content Lock Toggle -->
                        <div class="toggle-stack">
                            <label class="toggle-label" for="content-lock-toggle"> Folder Lock</label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="content-lock-toggle">
                            </div>
                        </div>

                        <!-- Content Scan Toggle -->
                        <div class="toggle-stack">
                            <label class="toggle-label" for="content-scan-toggle">Content Scan</label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="content-scan-toggle">
                            </div>
                        </div>


                        <!-- Hide Archive Toggle -->
                        <div class="toggle-stack">
                            <label class="toggle-label" for="hide-archive-toggle">Hide Archive</label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="hide-archive-toggle">
                            </div>
                        </div>

                        <!-- Refresh Button -->
                        <button id="refresh-media-btn" title="Refresh media list"
                            class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>

                        <!-- Settings Button (Admin Only) -->
                        <button id="settings-btn" title="Settings" class="btn btn-sm btn-outline-secondary"
                            onclick="showSettingsModal()">
                            <i class="bi bi-gear-fill"></i>
                        </button>

                        <!-- Fullscreen Button -->
                        <button id="page-fullscreen-toggle" title="Toggle Fullscreen">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Settings Unlock Modal -->
    <div class="modal fade" id="settings-unlock-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Unlock Settings</h5>
                    <button type="button" class="btn-close btn-close-white"
                        onclick="hideSettingsUnlockModal()"></button>
                </div>
                <div class="modal-body">
                    <form onsubmit="handleSettingsUnlock(event)">
                        <div class="mb-3">
                            <label for="settings-unlock-passphrase" class="form-label">Passphrase Required</label>
                            <input type="password" class="form-control bg-secondary text-light border-secondary"
                                id="settings-unlock-passphrase" required>
                        </div>
                        <div class="alert alert-danger" id="settings-unlock-error" style="display: none;"></div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Unlock</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Unlock Modal -->
    <div class="modal fade" id="action-unlock-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content bg-dark text-light border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="action-unlock-title">Unlock Action</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="hideActionUnlockModal()"></button>
                </div>
                <div class="modal-body">
                    <form onsubmit="handleActionUnlock(event)">
                        <input type="hidden" id="action-unlock-target">
                        <div class="mb-3">
                            <label for="action-unlock-passphrase" class="form-label">Passphrase Required</label>
                            <input type="password" class="form-control bg-secondary text-light border-secondary"
                                id="action-unlock-passphrase" required>
                        </div>
                        <div class="alert alert-danger" id="action-unlock-error" style="display: none;"></div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Unlock</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fullscreen API with cross-browser compatibility
        const fullscreenAPI = {
            enter: function (element) {
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
            },
            exit: function () {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            },
            isFullscreen: function () {
                return document.fullscreenElement ||
                    document.mozFullScreenElement ||
                    document.webkitFullscreenElement ||
                    document.msFullscreenElement;
            }
        };

        // Show metadata on hover
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize fullscreen button
            const fullscreenToggle = document.getElementById('page-fullscreen-toggle');
            const container = document.querySelector('.container');

            if (fullscreenToggle && container) {
                // Update button icon based on fullscreen state
                function updateFullscreenButton() {
                    if (fullscreenAPI.isFullscreen()) {
                        fullscreenToggle.innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
                        fullscreenToggle.title = 'Exit Fullscreen';
                    } else {
                        fullscreenToggle.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
                        fullscreenToggle.title = 'Enter Fullscreen';
                    }
                }

                // Toggle fullscreen on button click
                fullscreenToggle.addEventListener('click', function () {
                    if (fullscreenAPI.isFullscreen()) {
                        fullscreenAPI.exit();
                    } else {
                        fullscreenAPI.enter(container);
                    }
                });

                // Update button icon on fullscreen change
                document.addEventListener('fullscreenchange', updateFullscreenButton);
                document.addEventListener('mozfullscreenchange', updateFullscreenButton);
                document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
                document.addEventListener('msfullscreenchange', updateFullscreenButton);
            }

            // Handle refresh link
            const refreshLink = document.getElementById('refresh-link');
            if (refreshLink) {
                refreshLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    fetch('/refresh')
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                window.location.reload();
                            }
                        });
                });
            }

            // Handle refresh media button
            const refreshMediaBtn = document.getElementById('refresh-media-btn');
            if (refreshMediaBtn) {
                refreshMediaBtn.addEventListener('click', function () {
                    this.disabled = true;
                    this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    fetch('/refresh')
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                window.location.reload();
                            }
                        })
                        .catch(() => {
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                        });
                });
            }

            // DISABLED FOR PERFORMANCE - Metadata loading on hover
            // This was causing page timeouts with many items
            // Metadata is still loaded when clicking thumbnails
            /*
            document.querySelectorAll('.load-metadata').forEach(function (element) {
                element.addEventListener('mouseenter', function () {
                    const metadataContainer = this.querySelector('.metadata');
                    const filename = this.dataset.filename;
                    const subfolder = this.dataset.subfolder;

                    if (metadataContainer && !metadataContainer.dataset.loaded) {
                        fetch('/image_info/' + encodeURIComponent(filename))
                            .then(response => response.json())
                            .then(data => {
                                let metadataHtml = '';
                                if (data.prompt) {
                                    metadataHtml += `<p><strong>Prompt:</strong> ${data.prompt}</p>`;
                                }
                                if (data.seed) {
                                    metadataHtml += `<p><strong>Seed:</strong> ${data.seed}</p>`;
                                }
                                if (data.model) {
                                    metadataHtml += `<p><strong>Model:</strong> ${data.model}</p>`;
                                }
                                if (data.dimensions) {
                                    metadataHtml += `<p><strong>Dimensions:</strong> ${data.dimensions}</p>`;
                                }
                                if (data.date_time) {
                                    metadataHtml += `<p><strong>Created:</strong> ${data.date_time}</p>`;
                                }
                                if (data.subfolder || subfolder) {
                                    metadataHtml += `<p><strong>Folder:</strong> ${data.subfolder || subfolder}</p>`;
                                }

                                metadataContainer.innerHTML = metadataHtml;
                                metadataContainer.dataset.loaded = 'true';
                            });
                    }
                });
            });
            */
        });
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>