{% extends "base.html" %}

{% block content %}
<!-- Consolidated Navigation Bar -->
<div class="glass-card mb-3 p-3">
    <!-- Row 1: Breadcrumb + Sibling Folders on same line -->
    <div class="d-flex align-items-center mb-2" style="gap: var(--spacing-md);">
        <!-- Breadcrumb path -->
        <span class="text-muted" style="font-size: 0.9rem; white-space: nowrap;">
            <i class="bi bi-house-door"></i>
            <a href="{{ url_for('gallery') }}"
                style="color: var(--color-accent-primary); text-decoration: none;">Home</a>
            {% if breadcrumb_parts %}
            {% for i in range(breadcrumb_parts|length) %}
            {% set current_path = breadcrumb_parts[:i+1]|join('/') %}
            <i class="bi bi-chevron-right" style="font-size: 0.8rem;"></i>
            {% if i == breadcrumb_parts|length - 1 %}
            <strong>{{ breadcrumb_parts[i] }}</strong>
            {% else %}
            <a href="{{ url_for('gallery', subfolder=current_path) }}"
                style="color: var(--color-accent-primary); text-decoration: none;">{{ breadcrumb_parts[i] }}</a>
            {% endif %}
            {% endfor %}
            {% else %}
            <i class="bi bi-chevron-right" style="font-size: 0.8rem;"></i> <strong>All Images</strong>
            {% endif %}
        </span>

        <!-- Separator -->
        {% if (selected_subfolder and sibling_folders) or not selected_subfolder %}
        <span class="text-muted" style="font-size: 1.2rem;">|</span>

        <!-- Sibling folders OR top-level folders inline (text-style links) -->
        {% if selected_subfolder and sibling_folders %}
        <div style="margin: 0; display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
            {% for sibling in sibling_folders %}
            {% if '/' in selected_subfolder %}
            {% set parent_path = selected_subfolder.rsplit('/', 1)[0] %}
            {% set sibling_path = parent_path + '/' + sibling %}
            {% else %}
            {% set sibling_path = sibling %}
            {% endif %}
            <a href="{{ url_for('gallery', subfolder=sibling_path) }}"
                style="color: {% if sibling == current_folder %}var(--color-text-primary); font-weight: bold;{% else %}var(--color-accent-primary);{% endif %} text-decoration: none; font-size: 0.9rem;">
                <i class="bi bi-folder-fill"></i> {{ sibling }}
            </a>
            {% endfor %}
        </div>
        {% elif not selected_subfolder %}
        <div style="margin: 0; display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
            {% for subfolder in subfolders %}
            <a href="{{ url_for('gallery', subfolder=subfolder) }}"
                style="color: var(--color-accent-primary); text-decoration: none; font-size: 0.9rem;">
                <i class="bi bi-folder-fill"></i> {{ subfolder }}
            </a>
            {% endfor %}
        </div>
        {% endif %}
        {% endif %}

        <!-- Spacer to push controls to the right -->
        <div class="flex-grow-1"></div>

        <!-- Thumbnail Size Slider -->
        <div class="flex-shrink-0 d-flex align-items-center" style="min-width: 220px; gap: 8px;">
            <i class="bi bi-sliders" style="font-size: 0.85rem;"></i>
            <input type="range" class="form-range" id="gallery-thumbnail-slider" min="150" max="400" value="200"
                step="25" style="flex: 1;">
            <span id="gallery-thumbnail-size-label"
                style="font-size: 0.85rem; min-width: 50px; text-align: right;">200px</span>
        </div>

        <!-- Scan Content Button -->
        <button id="scan-content-btn" class="btn btn-sm btn-outline-warning" title="Scan folder for NSFW content">
            <i class="bi bi-shield-exclamation"></i> Scan Content
        </button>

        <!-- Search Bar -->
        <div class="flex-shrink-0" style="min-width: 300px; max-width: 400px;">
            <form action="{{ url_for('gallery') }}" method="get" id="search-form">
                <div class="input-group input-group-sm">
                    <span class="input-group-text glass-input"><i class="bi bi-search"></i></span>
                    <input type="text" id="image-search" name="search" class="form-control glass-input"
                        placeholder="Search..." value="{{ request.args.get('search', '') }}">
                    {% if selected_subfolder %}
                    <input type="hidden" name="subfolder" value="{{ selected_subfolder }}">
                    {% endif %}
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scan Progress Bar (hidden by default) -->
    <div id="scan-progress-container" style="display: none; margin-top: var(--spacing-sm);">
        <div class="progress" style="height: 20px;">
            <div id="scan-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <small id="scan-progress-text" class="text-muted">Scanning...</small>
    </div>

    <!-- Row 2: Child folders with L-shape indicator -->
    {% if child_folders %}
    <div class="d-flex align-items-start" style="gap: var(--spacing-sm); margin-top: var(--spacing-md);">
        <!-- L-shape indicator -->
        <div style="color: var(--color-text-secondary); font-size: 1.5rem; line-height: 1; margin-top: -4px;">
            â””
        </div>
        <div class="subfolder-nav" style="margin: 0;">
            {% for child in child_folders %}
            <a href="{{ url_for('gallery', subfolder=selected_subfolder + '/' + child) }}"
                class="btn btn-sm btn-outline-secondary subfolder-btn">
                <i class="bi bi-folder"></i> {{ child }}
            </a>
            {% endfor %}
        </div>
    </div>
    {% elif selected_subfolder and not sibling_folders %}
    <!-- No children and no siblings -->
    <div style="margin-top: var(--spacing-md);">
        <small class="text-muted"><i class="bi bi-info-circle"></i> No subfolders</small>
    </div>
    {% endif %}
</div>

<!-- Gallery Container -->
<div id="gallery-container">
    <!-- Gallery grid -->
    <div id="gallery-grid-container">
        <div class="image-grid" id="image-grid">
            {% for image in images %}
            <div class="image-container load-metadata gallery-item" data-filename="{{ image.filename }}"
                data-subfolder="{{ image.subfolder }}" data-index="{{ loop.index0 }}"
                data-media-type="{{ image.media_type }}">
                {% if image.media_type == 'video' %}
                <video src="{{ url_for('serve_image', filename=image.subfolder + '/' + image.filename) }}"
                    preload="metadata" class="thumbnail" muted playsinline webkit-playsinline></video>
                {% else %}
                <img src="{{ url_for('serve_image', filename=image.subfolder + '/' + image.filename) }}"
                    alt="{{ image.filename }}" class="thumbnail">
                {% endif %}
                <div class="metadata">
                    <!-- Metadata will be loaded via JavaScript -->
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Loading indicator for infinite scroll -->
        <div class="text-center mt-4 mb-4" id="scroll-status" data-total="{{ total_images }}">
            <p class="text-muted" id="scroll-status-text">Loaded <span id="loaded-count">{{ images|length }}</span> of
                <span id="total-count">{{ total_images }}</span> images</p>
        </div>
    </div>

    <!-- Large preview container (initially hidden via CSS width: 0) -->
    <div id="large-preview-container">
        <div class="preview-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-danger" id="delete-image-btn"
                        aria-label="Delete">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning" id="flag-nsfw-btn"
                        aria-label="Flag as NSFW">
                        <i class="bi bi-exclamation-triangle"></i> Flag
                    </button>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary" id="close-preview" aria-label="Close">
                    <i class="bi bi-x-lg"></i> Close
                </button>
            </div>
            <div class="preview-card-body">
                <div class="large-preview-image-container hero-view">
                    <img id="large-preview-image" src="" alt="" class="hero-image">
                    <div class="metadata" id="preview-metadata-overlay">
                        <!-- Metadata overlay on hover -->
                    </div>
                </div>
            </div>
            <div class="card-footer"
                style="background: var(--color-surface); border-top: 1px solid var(--color-border); padding: var(--spacing-md);">
                <div class="d-flex justify-content-between align-items-center gap-2">
                    <button type="button" class="btn btn-outline-primary flex-grow-1" id="prev-image">
                        <i class="bi bi-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="toggle-btn toggle-metadata-btn" title="Show Metadata">
                        <i class="bi bi-info-circle"></i>
                    </button>
                    <button type="button" class="toggle-btn toggle-fullscreen-btn" title="Enter Fullscreen">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary flex-grow-1" id="next-image">
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gallery-specific JavaScript -->
<script>
    // Gallery thumbnail size slider
    document.addEventListener('DOMContentLoaded', function () {
        const slider = document.getElementById('gallery-thumbnail-slider');
        const sizeLabel = document.getElementById('gallery-thumbnail-size-label');
        const imageGrid = document.querySelector('.image-grid');

        if (slider && imageGrid) {
            // Load saved size
            const savedSize = localStorage.getItem('galleryThumbnailSize') || slider.value;
            slider.value = savedSize;
            sizeLabel.textContent = savedSize + 'px';
            updateGalleryThumbnailSize(savedSize);

            // Handle slider changes
            slider.addEventListener('input', function () {
                const size = this.value;
                sizeLabel.textContent = size + 'px';
                updateGalleryThumbnailSize(size);
                localStorage.setItem('galleryThumbnailSize', size);
            });
        }

        function updateGalleryThumbnailSize(size) {
            // Set CSS variable on the image grid
            // This will automatically adjust the grid columns
            if (imageGrid) {
                imageGrid.style.setProperty('--thumbnail-size', size + 'px');
            }
        }
    });
</script>
{% endblock %}

{% block scripts %}
<!-- Shared metadata utilities -->
<script src="{{ url_for('static', filename='js/metadata_utils.js') }}"></script>
<!-- Media toggle controls -->
<script src="{{ url_for('static', filename='js/media_controls.js') }}"></script>
<script src="{{ url_for('static', filename='js/gallery.js') }}"></script>
<script src="{{ url_for('static', filename='js/infinite-scroll.js') }}"></script>
<!-- Actual size toggle functionality -->
<script src="{{ url_for('static', filename='js/actual_size_toggle.js') }}"></script>
<script src="{{ url_for('static', filename='js/hero_expand.js') }}"></script>
<!-- Custom video controls -->
<script src="{{ url_for('static', filename='js/video_controls.js') }}"></script>
{% endblock %}